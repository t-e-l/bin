#!/usr/bin/env bash
# SealyJ
# version 0.3
today=$(date +"%m_%d_%Y")
datetime=$(date +"%H_%M")
temp_storage=~/../usr/tmp
backup_location=~/storage/shared/tel/backup

check_folders(){
if [ ! -d $temp_storage ] ; then
	mkdir $temp_storage
fi
if [ ! -d ~/storage ] ; then
	printf "\e[38;5;2m Backup\e[m%s: "yy
	echo "Error - No access to phone storage"
	echo "backups are made to /storage/emulated/0/tel, (this path is also accessible to TEL through ~/storage/shared/tel) if TEL hasn't been granted storage permissions, this will likely fail. Run termux-setup-storage to grant access"
	echo "program will exit.." && exit_utility
fi
if [ ! -d ~/storage/shared/tel/backup ] ; then
	mkdir -p $backup_location 
fi
if [ ! -d "$backup_location/$today" ] ; then
	mkdir $backup_location/$today && printf "\e[38;5;2m Backup\e[m%s: created backup folder at: $backup_location/$today \n"
fi
}

make_backup(){
while true
do
	printf "\e[38;5;2m Backup\e[m%s: "
	read -p "This operation may overwrite previous backups made in the last minute, do you wish to continue? y/N : " answer
case $answer in
	[yY]* )
		
		read -p "Enter a unique name for this backup? (blank to skip): " user_chose_name
		check_folders  #create dirs if missing

		if [ ! -z "$user_chose_name" ] ; then 
			user_custom_name="_$user_chose_name"
		else
			user_custom_name=""
		fi
		printf "\e[38;5;2m Backup\e[m%s: creating installed pkgs list...\n"
		pkg list-installed > $backup_location/$today/$datetime_user_pkgs$user_custom_name 2>&1
		#do stuff here to capture pkgs for reinstall
		printf "\e[38;5;2m Backup\e[m%s: backing up configs...\n"
		cd ~/.tel/configs
		rm -rf .restore_path
		echo -n "$(pwd)" > .restore_path
		tar -v -c -z -f $backup_location/$today/$datetime_tel_confs$user_custom_name.tar.gz . >&/dev/null
		printf "\e[38;5;2m Backup\e[m%s: backing up termux settings...\n"
		cd ~/.termux
		rm -rf .restore_path
		echo -n "$(pwd)" > .restore_path
		tar -v -c -z -f $backup_location/$today/$datetime_termux$user_custom_name.tar.gz --exclude='shell' . >&/dev/null
		printf "\e[38;5;2m Backup\e[m%s: backing up TEL user data...\n"
		cd ~/.tel/data
		rm -rf .restore_path
		echo -n "$(pwd)" > .restore_path
		tar -v -c -z -f $backup_location/$today/$datetime_tel_data$user_chose_name.tar.gz . >&/dev/null &
		# last tar make archive must be child process	
		#show working spinner
		PID=$!
		i=1
		sp="/-\|"
		echo -n ' '
		while [ -d /proc/$PID ]
		do
			  printf "\b${sp:i++%${#sp}:1}"
			  sleep 0.1
		done
		echo -ne '\r' #remove last spinner
		printf "\e[38;5;2m Backup\e[m%s: completed\n"
		break;;

	[nN]* ) exit_utility;;
	* )     echo "options are y or n...";;
esac
done

}

restore_backup(){
	printf "\e[38;5;2m Restore\e[m%s: loading data...\n"
	cd $backup_location 
	backup_file_chosen=$(fzf -e --cycle --color=16 --prompt="Choose a backup file to restore from: ")
	[[ -z "$backup_file_chosen" ]] && exit 1
	while true
	do
		printf "\e[38;5;2m Restore\e[m%s: $backup_file_chosen\n"
		read -p "This will overwrite files relevant to the selected backup archive without any further warning! Are you sure you wish to continue? y/N : " answer
	case $answer in
		[yY]* )
			rm -r tmp > /dev/null 2>&1 # rm any partial failure
			mkdir tmp > /dev/null 2>&1 
			cd tmp	
			tar -x -U -f ../$backup_file_chosen --keep-directory-symlink
			printf "\e[38;5;2m Restore\e[m%s: restoring from archive -> $backup_file_chosen -> $(cat .restore_path)\n"
			cp -rf * "$(cat .restore_path)" && printf "\e[38;5;2m Restore\e[m%s: successfully restored $numfiles\n"
			cd ..
			rm -r tmp # cleanup	

			# last tar make archive must be child process	
			#show working spinner
			PID=$!
			i=1
			sp="/-\|"
			echo -n ' '
			while [ -d /proc/$PID ]
			do
				  printf "\b${sp:i++%${#sp}:1}"
				  sleep 0.1
			done
			echo -ne '\r' #remove last spinner
			printf "\e[38;5;2m Restore\e[m%s: complete\n"
			break;;

		[nN]* ) exit_utility;;
		* )     echo "options are y or n...";;
	esac
	done

}

exit_utility(){
	printf "\e[38;5;2m Backup & Restore\e[m%s: Exiting...\n"
	exit 0
}

main() {

printf "\e[38;5;2m Backup & Restore\e[m%s\n"

HEIGHT=15
WIDTH=40
CHOICE_HEIGHT=4
BACKTITLE="tel-backup"
TITLE="Backup & Restore"
MENU="Choose one of the following options:"

OPTIONS=(1 " Backup"
         2 " Restore"
         3 " Quit")

CHOICE=$(dialog --clear \
                --backtitle "$BACKTITLE" \
                --title "$TITLE" \
                --menu "$MENU" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 >/dev/tty)

clear
case $CHOICE in
        1)
	    make_backup
            ;;
        2)
	    restore_backup
            ;;
        3)
	    exit_utility
            ;;
esac
}

main $@

